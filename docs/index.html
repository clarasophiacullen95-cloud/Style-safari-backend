<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Style Safari AI Stylist</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Style Safari AI Stylist</h1>

    <!-- User Profile Form -->
    <div id="profile-form">
      <h2>Your Profile</h2>
      <label>Gender:
        <select id="gender">
          <option value="female">Female</option>
          <option value="male">Male</option>
          <option value="unisex">Unisex</option>
        </select>
      </label>
      <label>Style:
        <input type="text" id="style" placeholder="Minimalist, Boho, Streetwear...">
      </label>
      <label>Budget Min:
        <input type="number" id="budget_min" placeholder="0">
      </label>
      <label>Budget Max:
        <input type="number" id="budget_max" placeholder="1000">
      </label>
      <label>Color Preferences:
        <input type="text" id="colors" placeholder="White, Black, Blue...">
      </label>
      <button id="fetch-outfits">Curate My Looks</button>
    </div>

    <!-- Refresh Button -->
    <div>
      <button id="manual-refresh">Refresh Product Feed</button>
      <p id="refresh-status"></p>
    </div>

    <!-- AI Outfit Recommendations -->
    <div id="outfits">
      <h2>AI Outfit Recommendations</h2>
      <div id="outfit-list"></div>
    </div>

    <!-- Search -->
    <div id="search-section">
      <h2>Search Products</h2>
      <input type="text" id="search-query" placeholder="Search products...">
      <button id="search-btn">Search</button>
      <div id="search-results"></div>
    </div>
  </div>

  <script>
    const backendUrl = "https://style-safari-backend.vercel.app";

    // Fetch AI Outfits
    document.getElementById("fetch-outfits").addEventListener("click", async () => {
      const profile = {
        gender: document.getElementById("gender").value,
        style: document.getElementById("style").value,
        budget_min: Number(document.getElementById("budget_min").value),
        budget_max: Number(document.getElementById("budget_max").value),
        colors: document.getElementById("colors").value.split(",").map(c => c.trim())
      };

      const outfitsEl = document.getElementById("outfit-list");
      outfitsEl.innerHTML = "Loading...";

      try {
        const res = await fetch(`${backendUrl}/api/ai-outfits`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(profile)
        });
        const data = await res.json();

        outfitsEl.innerHTML = "";
        if (!data.length) {
          outfitsEl.innerHTML = "<p>No outfits found.</p>";
          return;
        }

        data.forEach((outfit, idx) => {
          const div = document.createElement("div");
          div.className = "outfit";
          div.innerHTML = `<h3>Outfit ${idx + 1}</h3>` + outfit.products.map(p => `
            <div class="product">
              <img src="${p.image_url}" alt="${p.name}" width="100">
              <p>${p.name} - ${p.price} ${p.currency}</p>
              <a href="${p.affiliate_link}" target="_blank">Buy</a>
            </div>
          `).join("");
          outfitsEl.appendChild(div);
        });
      } catch (e) {
        outfitsEl.innerHTML = `<p>Error: ${e.message}</p>`;
      }
    });

    // Manual Refresh
    document.getElementById("manual-refresh").addEventListener("click", async () => {
      const statusEl = document.getElementById("refresh-status");
      statusEl.textContent = "Refreshing...";

      try {
        const res = await fetch(`${backendUrl}/api/sync?secret=stylesafari`);
        const data = await res.json();
        statusEl.textContent = `Refresh Complete: ${data.count} products synced.`;
      } catch (e) {
        statusEl.textContent = `Error: ${e.message}`;
      }
    });

    // Product Search
    document.getElementById("search-btn").addEventListener("click", async () => {
      const q = document.getElementById("search-query").value;
      const gender = document.getElementById("gender").value;
      const resultsEl = document.getElementById("search-results");
      resultsEl.innerHTML = "Searching...";

      try {
        const res = await fetch(`${backendUrl}/api/ai-search?q=${encodeURIComponent(q)}&gender=${gender}`);
        const data = await res.json();
        resultsEl.innerHTML = "";

        if (!data.length) {
          resultsEl.innerHTML = "<p>No products found.</p>";
          return;
        }

        data.forEach(p => {
          const div = document.createElement("div");
          div.className = "product";
          div.innerHTML = `
            <img src="${p.image_url}" alt="${p.name}" width="80">
            <p>${p.name} - ${p.price} ${p.currency}</p>
            <a href="${p.affiliate_link}" target="_blank">Buy</a>
          `;
          resultsEl.appendChild(div);
        });
      } catch (e) {
        resultsEl.innerHTML = `<p>Error: ${e.message}</p>`;
      }
    });
  </script>
</body>
</html>
